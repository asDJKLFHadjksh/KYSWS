<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order</title>
  <link rel="icon" type="image/svg+xml" href="img/favicon_v2.svg"> <!-- set favicon -->
  <meta name="description" content="Form order paket. Hitung harga otomatis, validasi deadline realistis, buffer fee, generate order code, kirim ke WhatsApp." />
  <link rel="stylesheet" href="assets/css/theme.css">
  <link rel="stylesheet" href="assets/css/theme-custom.css">
  <style>
    :root{ --bg:var(--site-bg); --card:var(--site-surface); --accent:var(--site-accent); --muted:var(--site-muted); --glass: var(--site-glass); --gold:#FFD54F; --gold-text:#2a2200; --disabled:#303030; }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--site-font); background:radial-gradient(circle at top, var(--site-bg-soft), var(--bg)); color:var(--site-text); padding:24px; display:flex; justify-content:center}
    .container{max-width:900px; width:100%}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo img{width:40px;height:40px;border-radius:0;object-fit:cover}
    h1{font-size:18px}
    p.lead{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns: 1.2fr 1fr; gap:16px}
    @media (max-width:800px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.05);box-shadow:0 6px 18px rgba(0,0,0,0.4)}
    .card h2{font-size:16px;margin-bottom:10px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type='number'], input[type='url'], textarea{width:100%;background:#1f1f1f;border:1px solid rgba(255,255,255,0.08);color:#fff;border-radius:10px;padding:10px;font-size:14px}
    input[type='number']{appearance:textfield}
    textarea{min-height:160px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){.row{grid-template-columns:1fr}}
    .helper{font-size:12px;color:var(--muted);margin-top:6px}
    .warn{color:#ffd166}
    .err{color:#ff4d4f}
    .summary div{display:flex;justify-content:space-between;margin:6px 0;font-size:14px}
    .summary .total{font-weight:800;font-size:18px;margin-top:8px;border-top:1px dashed rgba(255,255,255,0.12);padding-top:8px}
    .order-detail-row{display:flex;align-items:baseline;justify-content:flex-start;gap:6px;margin-bottom:8px;font-size:14px;color:#EDEDED}
    .order-detail-label{display:flex;align-items:center;gap:8px;color:#EDEDED;font-weight:600}
    .order-detail-dot{width:8px;height:8px;border-radius:999px;display:inline-block;flex:0 0 8px}
    .dot-paket{background:#9BE870}
    .dot-overtime{background:#7AB8FF}
    .dot-deadline{background:#FF8A8A}
    .dot-buffer{background:#FFC47A}
    .dot-revisi{background:#CBB6FF}
    .order-detail-value{font-weight:600}
    .order-detail-note{font-size:12px;color:var(--muted);margin:-2px 0 8px 24px}
    .val-paket{color:#9BE870}
    .val-overtime{color:#7AB8FF}
    .val-deadline{color:#FF8A8A}
    .val-buffer{color:#FFC47A}
    .val-revisi{color:#CBB6FF}
    .order-detail-sum-row{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.08);justify-content:flex-start}
    .order-detail-sum-expression{display:flex;flex-wrap:wrap;gap:6px 8px;font-size:13px;justify-content:flex-start}
    .order-detail-sum-part{font-weight:600}
    .order-detail-sum-operator{color:var(--muted);font-weight:500}
    .order-detail-total{margin-top:12px;padding-top:10px;border-top:1px dashed rgba(255,255,255,0.15);font-weight:700}
    .order-detail-subtotal{margin-top:6px;font-weight:600;font-size:14px;display:flex;align-items:baseline;justify-content:space-between;color:#EDEDED}
    .revision-sim{margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.08)}
    .revision-sim summary{list-style:none;cursor:pointer;font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;background:var(--site-accent-fade);border:1px dashed var(--site-accent-soft);transition:all .2s ease}
    .revision-sim summary::after{content:"+";margin-left:auto;font-weight:700;color:var(--site-accent)}
    .revision-sim:not([open]) summary{box-shadow:0 0 0 2px rgba(138,78,255,0.12)}
    .revision-sim summary::-webkit-details-marker{display:none}
    .revision-sim[open] summary{margin-bottom:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08)}
    .revision-sim[open] summary::after{content:"‚àí"}
    .summary-details{margin-top:10px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.08)}
    .summary-details summary{list-style:none;cursor:pointer;font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;background:var(--site-accent-fade);border:1px dashed var(--site-accent-soft);transition:all .2s ease}
    .summary-details summary::after{content:"+";margin-left:auto;font-weight:700;color:var(--site-accent)}
    .summary-details:not([open]) summary{box-shadow:0 0 0 2px rgba(138,78,255,0.12)}
    .summary-details summary::-webkit-details-marker{display:none}
    .summary-details[open] summary{margin-bottom:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08)}
    .summary-details[open] summary::after{content:"‚àí"}
    .revision-sim .preview-note{font-size:11px;opacity:0.7;font-weight:500}
    .revision-note{font-size:12px;color:var(--muted);margin-top:6px}
    .revision-input{margin-top:8px}
    .btn{background:var(--accent);color:white;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none;border:0;display:inline-block;transition:all .2s ease}
    .btn.gold{background:var(--gold);color:var(--gold-text)}
    .btn[disabled]{background:var(--disabled);color:#ccc;cursor:not-allowed;opacity:1}
    .btn-copy{background:var(--glass);color:#fff;border:1px solid rgba(255,255,255,0.12);padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;cursor:pointer}
    .btn-copy.copied{background:var(--accent);color:#f5f3ff;border-color:var(--site-accent-strong)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);font-size:12px;color:#fff;margin-top:12px}
    .muted{color:var(--muted)}
    .counter{font-size:12px;color:var(--muted);margin-top:4px;text-align:right}
    .warn-limit{color:#ffd166;font-size:12px;text-align:right;display:none}
    input.invalid{border:1px solid #ff4d4f}
    .nav-btn{margin-bottom:16px;display:inline-block;background:transparent;color:var(--accent);text-decoration:none;font-size:14px;font-weight:bold}
    .order-code-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .copy-status{font-size:12px;color:var(--muted)}
    .visually-hidden{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <main class="container">
    <header>
      <div class="brand">
        <div class="logo"><img src="img/Logo.png" alt="Logo"></div> <!-- path updated -->
        <div>
          <h1>Order ‚Äî <span id="pkgName">Loading...</span></h1>
          <p class="lead">Hitung harga otomatis ‚Ä¢ Validasi deadline realistis ‚Ä¢ Buffer fee durasi panjang ‚Ä¢ WhatsApp redirect</p>
        </div>
      </div>
      <div class="muted" style="font-size:17px; color:var(--accent); font-weight:bold;">Tidak ada nego atau harga temen!</div>
    </header>

    <a href="etalase/" class="nav-btn">‚Üê Kembali</a>

    <section class="grid">
      <article class="card">
        <h2>Form Pesanan</h2>
        <div class="row">
          <div>
            <label for="durasi">Durasi total (menit) *</label>
            <input id="durasi" type="number" min="1" step="1" required>
            <div class="helper">Biaya 5+ dihitung untuk durasi di atas 5 menit.</div>
          </div>
          <div>
            <label for="deadline">Deadline (hari) *</label>
            <input id="deadline" type="number" step="1" required>
            <div id="deadlineHelper" class="helper">Perhitungan dimulai <b>hari berikutnya sesuai jam kerja</b> setelah <b>file RAW diterima</b>.</div>
          </div>
        </div>
        <div>
          <label for="ref">Link referensi (opsional)</label>
          <input id="ref" type="url" placeholder="https://...">
          <div id="refErr" class="helper err" style="display:none">Link tidak valid.</div>
        </div>
        <div>
          <label for="note">Brief (catatan):</label>
          <textarea id="note" minlength="80" maxlength="1200" placeholder="Tulis brief jelas..." required></textarea>
          <div class="helper">Contoh: "cut saat saya tidak berbicara ke kamera, ambil momen lucu."</div>
          <div id="noteErr" class="helper err" style="display:none">Brief terlalu pendek. Minimal 80 karakter.</div>
          <div id="noteCounter" class="counter">0 / 1200</div>
          <div id="noteWarn" class="warn-limit">‚ö†Ô∏è Hampir mencapai batas maksimal WhatsApp (1200 karakter)</div>
        </div>
      </article>

      <aside class="card">
        <h2>Biaya</h2>
        <div class="summary">
          <div class="order-detail-total"><span>Total</span><span id="sumTotal">IDR 0</span></div>
          <details class="summary-details">
            <summary>Detail Biaya</summary>
            <div class="order-detail-row">
              <span class="order-detail-label"><span class="order-detail-dot dot-paket"></span>Harga Paket:</span>
              <span class="order-detail-value val-paket" id="sumBase">IDR 0</span>
            </div>
            <div class="order-detail-row">
              <span class="order-detail-label"><span class="order-detail-dot dot-overtime"></span>Biaya 5+:</span>
              <span class="order-detail-value val-overtime" id="sumOver">0 mnt √ó IDR 0 = IDR 0</span>
            </div>
            <div class="order-detail-note">Biaya 5+ dihitung untuk durasi di atas 5 menit.</div>
            <div class="order-detail-row">
              <span class="order-detail-label"><span class="order-detail-dot dot-deadline"></span>Deadline Surcharge:</span>
              <span class="order-detail-value val-deadline" id="sumSurcharge">+0% = IDR 0</span>
            </div>
            <div class="order-detail-row">
              <span class="order-detail-label"><span class="order-detail-dot dot-buffer"></span>Buffer Fee:</span>
              <span class="order-detail-value val-buffer" id="sumBuffer">+0% = IDR 0</span>
            </div>
            <div class="order-detail-row order-detail-sum-row">
              <span class="order-detail-sum-expression">
                <span class="order-detail-sum-part val-paket" id="sumPartBase">IDR 0</span>
                <span class="order-detail-sum-operator">+</span>
                <span class="order-detail-sum-part val-overtime" id="sumPartOver">IDR 0</span>
                <span class="order-detail-sum-operator">+</span>
                <span class="order-detail-sum-part val-deadline" id="sumPartSurcharge">IDR 0</span>
                <span class="order-detail-sum-operator">+</span>
                <span class="order-detail-sum-part val-buffer" id="sumPartBuffer">IDR 0</span>
              </span>
            </div>
            <div class="order-detail-subtotal">
              <span>Subtotal (tanpa revisi):</span>
              <span id="sumSubtotal">IDR 0</span>
            </div>
            <div class="helper">Estimasi selesai: <b id="eta">-</b></div>
          </details>
        </div>
        <details class="revision-sim">
          <summary>Simulasi Revisi <span class="preview-note">(preview)</span></summary>
          <label for="revisionCount">Perkiraan jumlah revisi (x)</label>
          <input id="revisionCount" class="revision-input" type="number" min="0" step="1" value="0">
          <div class="helper">Gratis revisi <span id="revisionIncluded">0x</span>, tambahan <span id="revisionExtra">0x</span>.</div>
          <div class="order-detail-row">
            <span class="order-detail-label"><span class="order-detail-dot dot-revisi"></span>Biaya Revisi Tambahan:</span>
            <span class="order-detail-value val-revisi" id="revisionFee">IDR 0</span>
          </div>
          <div class="order-detail-row order-detail-sum-row">
            <span class="order-detail-sum-expression">
              <span class="order-detail-sum-part" id="revisionSubtotal">IDR 0</span>
              <span class="order-detail-sum-operator">+</span>
              <span class="order-detail-sum-part val-revisi" id="revisionFeePart">IDR 0</span>
            </span>
          </div>
          <div class="order-detail-total">Total dengan revisi: <span id="revisionTotal">IDR 0</span></div>
          <div class="revision-note">Simulasi ini tidak ikut dikirim ke WhatsApp.</div>
        </details>
        <div id="surchargeNote" class="helper warn" style="display:none"></div>
        <div style="margin-top:16px;display:flex;flex-direction:column;align-items:flex-start;gap:8px">
          <button id="btnOrder" class="btn" disabled>Order via WhatsApp</button>
          <div class="order-code-actions">
            <span id="orderCode" class="pill visually-hidden" title="Order Code"></span>
            <button id="copyOrderCode" class="btn-copy" type="button">Copy Code</button>
            <span id="copyStatus" class="copy-status visually-hidden" role="status" aria-live="polite"></span>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <script src="assets/js/pricing.js"></script>
  <script>
    function encodeKYS(payload){
      const compactPayload={
        pid:payload.packageId,
        dur:payload.duration,
        ddl:payload.deadline,
        nl:payload.noteLength,
        ts:payload.timestamp
      };
      const json=JSON.stringify(compactPayload);
      const encoded=btoa(json);
      return `KYS-${encoded}`;
    }
    function formatTimestamp(value){
      const date=value instanceof Date?value:new Date();
      const pad=number=>String(number).padStart(2,'0');
      return [
        date.getFullYear(),
        pad(date.getMonth()+1),
        pad(date.getDate())
      ].join('')+`-${pad(date.getHours())}${pad(date.getMinutes())}${pad(date.getSeconds())}`;
    }
    function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
    function nextDayStart(){ const d=new Date(); d.setDate(d.getDate()+1); d.setHours(0,0,0,0); return d; }
    function isValidUrl(u){ try{ new URL(u); return true; }catch(e){ return false; } }
    function formatPercent(value){
      const num=Number(value);
      if(!Number.isFinite(num)) return '0';
      return parseFloat(num.toFixed(2)).toString();
    }
    function formatDays(value){
      const num=Number(value);
      if(!Number.isFinite(num)) return '-';
      return parseFloat(num.toFixed(2)).toString();
    }
    function computeRevisionFee(revisionCount, pkg, subtotal){
      const revisiUsed=parseInt(revisionCount,10)||0;
      const included=Number(pkg?.included_revisions ?? pkg?.revisions ?? 0) || 0;
      const extraCount=Math.max(0,revisiUsed-included);
      const revisionPercent=Number(pkg?.extra_revision_percent)||0;
      const baseAmount=Number(subtotal)||0;
      const fee=extraCount>0 && revisionPercent>0
        ? Math.round(baseAmount*(revisionPercent/100)*extraCount)
        : 0;
      return {revisiUsed,included,extraCount,revisionPercent,fee};
    }

    const BRIEF_CACHE_KEY='kys-order-brief-cache';
    const BRIEF_CACHE_TTL_MS=60*60*1000;

    function saveBriefCache(value){
      const payload={text:value,ts:Date.now()};
      localStorage.setItem(BRIEF_CACHE_KEY,JSON.stringify(payload));
    }

    function clearBriefCache(noteInput){
      localStorage.removeItem(BRIEF_CACHE_KEY);
      if(noteInput){
        noteInput.value='';
      }
    }

    function restoreBriefCache(noteInput){
      if(!noteInput) return;
      const raw=localStorage.getItem(BRIEF_CACHE_KEY);
      if(!raw){
        return;
      }
      try{
        const payload=JSON.parse(raw);
        const cachedText=typeof payload?.text === 'string' ? payload.text : '';
        const cachedTs=Number(payload?.ts);
        const isExpired=!Number.isFinite(cachedTs)||(Date.now()-cachedTs>BRIEF_CACHE_TTL_MS);
        if(isExpired || !cachedText){
          clearBriefCache(noteInput);
          return;
        }
        noteInput.value=cachedText;
      }catch(error){
        clearBriefCache(noteInput);
      }
    }

    let pkg=null; let cfg=null; let promo=null;
    let copyStatusTimeout=null;

    (async function init(){
      try{
        const data = await Pricing.loadConfig(".");
        cfg = data.prices;
        promo = data.promo;

        const id=new URLSearchParams(window.location.search).get("id");
        pkg = cfg.packages.find(p=>String(p.id)===String(id));
        if(!pkg) throw new Error("Paket tidak ditemukan");

        document.getElementById('pkgName').textContent = pkg.name;

        const durasiInput=document.getElementById('durasi');
        const deadlineInput=document.getElementById('deadline');
        const refInput=document.getElementById('ref');
        const noteInput=document.getElementById('note');
        const revisionInput=document.getElementById('revisionCount');

        durasiInput.addEventListener('input',()=>update({reason:'durasi'}));
        durasiInput.addEventListener('change',()=>update({reason:'durasi'}));

        deadlineInput.addEventListener('input',()=>update({enforceDeadlineMin:false,reason:'deadline-input'}));
        deadlineInput.addEventListener('blur',()=>update({enforceDeadlineMin:true,reason:'blur'}));

        refInput.addEventListener('input',()=>update({reason:'ref'}));
        refInput.addEventListener('change',()=>update({reason:'ref'}));

        restoreBriefCache(noteInput);
        updateCounter();

        noteInput.addEventListener('input',()=>{
          saveBriefCache(noteInput.value);
          update({enforceDeadlineMin:false,reason:'note'});
          updateCounter();
        });
        noteInput.addEventListener('change',()=>update({reason:'note-change'}));
        revisionInput.addEventListener('input',()=>update({enforceDeadlineMin:false,reason:'revision'}));
        revisionInput.addEventListener('change',()=>update({enforceDeadlineMin:false,reason:'revision-change'}));

        document.getElementById('btnOrder').addEventListener('click',onOrder);
        document.getElementById('copyOrderCode').addEventListener('click',copyOrderCode);
        update({reason:'init'});
      }catch(err){
        console.error('Init error:', err);
        alert('Config error: '+err.message);
      }
    })();

    function update(options={}){
      const {enforceDeadlineMin=true,reason=''}=options;
      if(!pkg) return;
      const durasiInput=document.getElementById('durasi');
      const deadlineInput=document.getElementById('deadline');
      const deadlineHelper=document.getElementById('deadlineHelper');
      const defaultHelper=`Perhitungan dimulai <b>hari berikutnya sesuai jam kerja</b> setelah <b>file RAW diterima</b>.`;

      const durasiRaw=parseInt(durasiInput.value||0,10);
      const durasi=Number.isFinite(durasiRaw)&&durasiRaw>0?durasiRaw:1;

      const policy=Pricing.getDeadlineGuidance(pkg,durasi);
      const minDays=policy.defaultDays;
      deadlineInput.dataset.minDays=String(minDays);

      const currentValue=(deadlineInput.value||'').trim();
      const parsedDeadline=parseInt(currentValue,10);
      const hasValidDeadline=Number.isFinite(parsedDeadline);

      let days=minDays;
      let helperMessage=defaultHelper;

      if(enforceDeadlineMin){
        const needsRestore=!hasValidDeadline||parsedDeadline<minDays;
        if(!currentValue||needsRestore){
          deadlineInput.value=String(minDays);
          days=minDays;
          helperMessage=needsRestore&&reason==='blur'?`<span class='warn'>Deadline minimum otomatis dikembalikan ke ${minDays} hari.</span>`:defaultHelper;
        } else {
          days=parsedDeadline;
          helperMessage=defaultHelper;
        }
      } else {
        if(hasValidDeadline){
          days=Math.max(minDays,parsedDeadline);
          if(parsedDeadline<minDays){
            helperMessage=`<span class='warn'>Deadline minimum untuk paket ini ${minDays} hari.</span>`;
          }
        } else {
          days=minDays;
          if(currentValue){
            helperMessage=`<span class='warn'>Deadline minimum untuk paket ini ${minDays} hari.</span>`;
          }
        }
        if(!currentValue){
          helperMessage=`<span class='warn'>Deadline minimum untuk paket ini ${minDays} hari.</span>`;
        }
      }

      if(enforceDeadlineMin&&reason!=='blur'){
        helperMessage=defaultHelper;
      }

      deadlineHelper.innerHTML=helperMessage;
      const noteValue=document.getElementById('note').value||'';
      const note=noteValue.trim();
      const noteLength=noteValue.length;
      const ref=(document.getElementById('ref').value||'').trim();

      const noteErr=document.getElementById('noteErr');
      const noteOK=note.length>=80;
      noteErr.style.display=noteOK?'none':'block';

      const refInput=document.getElementById('ref');
      const refErr=document.getElementById('refErr');
      let refOK=true;
      if(ref && !isValidUrl(ref)){
        refInput.classList.add('invalid');
        refErr.style.display='block';
        refOK=false;
      } else { refInput.classList.remove('invalid'); refErr.style.display='none'; }

      const calc = Pricing.calcTotal(pkg, cfg, promo, durasi, days);

      if (calc.discountPercent > 0) {
        document.getElementById('sumBase').innerHTML = `
          ${Pricing.fmtIDR(calc.baseFinal)} <span class="muted">(-${calc.discountPercent}%)</span><br>
          <s style="font-size:12px;color:var(--muted)">${Pricing.fmtIDR(calc.normal)}</s>
        `;
      } else {
        document.getElementById('sumBase').textContent = Pricing.fmtIDR(calc.baseFinal);
      }

      document.getElementById('sumOver').textContent=`${calc.overMin} mnt √ó ${Pricing.fmtIDR(calc.overRate)} = ${Pricing.fmtIDR(calc.overCost)}`;
      document.getElementById('sumSurcharge').textContent=`+${formatPercent(calc.surPerc)}% = ${Pricing.fmtIDR(calc.surchargeVal)}`;
      document.getElementById('sumBuffer').textContent=`+${calc.bufPerc}% = ${Pricing.fmtIDR(calc.bufVal)}`;
      document.getElementById('sumPartBase').textContent=Pricing.fmtIDR(calc.baseFinal);
      document.getElementById('sumPartOver').textContent=Pricing.fmtIDR(calc.overCost);
      document.getElementById('sumPartSurcharge').textContent=Pricing.fmtIDR(calc.surchargeVal);
      document.getElementById('sumPartBuffer').textContent=Pricing.fmtIDR(calc.bufVal);
      const subtotalWithoutRevision=calc.baseFinal+calc.overCost+calc.surchargeVal+calc.bufVal;
      document.getElementById('sumSubtotal').textContent=Pricing.fmtIDR(subtotalWithoutRevision);
      document.getElementById('sumTotal').textContent=Pricing.fmtIDR(calc.total);
      document.getElementById('eta').textContent=addDays(nextDayStart(),days-1).toLocaleDateString('id-ID',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});

      const surchargeNote=document.getElementById('surchargeNote');
      if(calc.surPerc>0 && calc.deadline?.surchargePercent){
        const idealRate=calc.deadline?.idealDaysPerMinute ?? policy.idealDaysPerMinute;
        const recommendedRaw=Number.isFinite(calc.deadline?.idealTotalDays)?calc.deadline.idealTotalDays:(idealRate||0)*durasi;
        const recommendedText=formatDays(recommendedRaw);
        surchargeNote.style.display='block';
        surchargeNote.textContent=`üí° Catatan: Semakin lama deadline yang Anda pilih (hingga ${recommendedText} hari), semakin kecil biaya Deadline Surcharge.`;
      } else {
        surchargeNote.style.display='none';
        surchargeNote.textContent='';
      }

      const revisionInput=document.getElementById('revisionCount');
      const revisionInfo=computeRevisionFee(revisionInput.value,pkg,subtotalWithoutRevision);
      const revisionPercentText=formatPercent(revisionInfo.revisionPercent);
      document.getElementById('revisionIncluded').textContent=`${revisionInfo.included}x`;
      document.getElementById('revisionExtra').textContent=`${revisionInfo.extraCount}x`;
      document.getElementById('revisionFee').textContent=`${Pricing.fmtIDR(revisionInfo.fee)} (${revisionPercentText}% √ó Subtotal ${Pricing.fmtIDR(subtotalWithoutRevision)} √ó ${revisionInfo.extraCount}x)`;
      document.getElementById('revisionSubtotal').textContent=Pricing.fmtIDR(subtotalWithoutRevision);
      document.getElementById('revisionFeePart').textContent=Pricing.fmtIDR(revisionInfo.fee);
      document.getElementById('revisionTotal').textContent=Pricing.fmtIDR(subtotalWithoutRevision+revisionInfo.fee);

      const code=encodeKYS({
        packageId:pkg.id,
        duration:durasi,
        deadline:days,
        noteLength,
        timestamp:formatTimestamp()
      });
      document.getElementById('orderCode').textContent=code;

      const phoneOK=!!(cfg.whatsapp&&/^[\d]{9,15}$/.test(String(cfg.whatsapp)));
      const formOK=durasi>=1&&days>=1&&noteOK&&refOK&&phoneOK;
      const btn=document.getElementById('btnOrder');
      btn.disabled=!formOK;
      btn.classList.toggle('gold', calc.discountPercent>0 && !btn.disabled);
      btn.dataset.calc=JSON.stringify(calc);
      btn.dataset.note=note;
      btn.dataset.ref=ref;
      btn.dataset.code=code;
      btn.dataset.durasi=durasi;
      btn.dataset.days=days;
    }

    function updateCounter(){
      const note=document.getElementById('note');
      const counter=document.getElementById('noteCounter');
      const warn=document.getElementById('noteWarn');
      counter.textContent=`${note.value.length} / 1200`;
      warn.style.display = note.value.length >= 1080 ? 'block' : 'none';
    }

    function onOrder(){
      const btn=document.getElementById('btnOrder');
      const calc=JSON.parse(btn.dataset.calc);
      const phone=String(cfg.whatsapp);
      const codeRaw=btn.dataset.code;
      const copyLink=location.origin+"/ct/#"+encodeURIComponent(codeRaw);
      const msg=[
        `*Paket:* ${pkg.name}`,
        `*Durasi:* ${btn.dataset.durasi} menit`,
        `*Deadline:* ${btn.dataset.days} hari (mulai sesuai jam kerja, setelah file RAW diterima)\n`,
        `*Rincian Biaya:*`,
        `> Harga normal: ${Pricing.fmtIDR(calc.normal)}`,
        calc.discountPercent>0?`> Diskon ${calc.discountPercent}%: -${Pricing.fmtIDR(calc.normal-calc.baseFinal)}`:null,
        `> Base price: ${Pricing.fmtIDR(calc.baseFinal)}`,
        `> Biaya 5+: ${calc.overMin} mnt √ó ${Pricing.fmtIDR(calc.overRate)} = ${Pricing.fmtIDR(calc.overCost)}`,
        `> Deadline surcharge: +${formatPercent(calc.surPerc)}% = ${Pricing.fmtIDR(calc.surchargeVal)}`,
        `> Buffer fee: +${calc.bufPerc}% = ${Pricing.fmtIDR(calc.bufVal)}`,
        `> ${Pricing.fmtIDR(calc.baseFinal)} + ${Pricing.fmtIDR(calc.overCost)} + ${Pricing.fmtIDR(calc.surchargeVal)} + ${Pricing.fmtIDR(calc.bufVal)}`,
        `> Total: *${Pricing.fmtIDR(calc.total)}*\n`,
        `*Link Tracker:* ${copyLink}\n`,
        btn.dataset.ref?`*Referensi:* ${btn.dataset.ref}\n`:null,
        `*Brief:* ${btn.dataset.note}`
      ].filter(Boolean).join('\n');

      const url=`https://wa.me/${phone}?text=`+encodeURIComponent(msg);
      window.location.href=url;
    }

    async function copyOrderCode(){
      const code=document.getElementById('orderCode').textContent.trim();
      if(!code) return;
      const copyButton=document.getElementById('copyOrderCode');
      const status=document.getElementById('copyStatus');

      const setStatus=(message,isSuccess)=>{
        status.textContent=message;
        copyButton.classList.toggle('copied',isSuccess);
        if(copyStatusTimeout) clearTimeout(copyStatusTimeout);
        copyStatusTimeout=setTimeout(()=>{
          status.textContent='';
          copyButton.classList.remove('copied');
        },2000);
      };

      try{
        if(navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(code);
        } else {
          const temp=document.createElement('textarea');
          temp.value=code;
          temp.setAttribute('readonly','');
          temp.style.position='absolute';
          temp.style.left='-9999px';
          document.body.appendChild(temp);
          temp.select();
          document.execCommand('copy');
          document.body.removeChild(temp);
        }
        setStatus('Order code disalin.',true);
      }catch(error){
        console.error('Copy failed:',error);
        setStatus('Gagal menyalin order code.',false);
      }
    }
  </script>
</body>
</html>
